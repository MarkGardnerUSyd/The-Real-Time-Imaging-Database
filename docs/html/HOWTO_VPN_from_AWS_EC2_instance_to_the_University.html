
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Setting up VPN access to the University Network from an EC2 instance &#8212; Packaging Demo  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="HOW TO Add New Trial/Test Centre/Patient Information" href="HOW_TO_Add_new_patient_information.html" />
    <link rel="prev" title="LEARN DB Deployment Guide" href="Local_Deployment_Guide.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="setting-up-vpn-access-to-the-university-network-from-an-ec2-instance">
<h1>Setting up VPN access to the University Network from an EC2 instance<a class="headerlink" href="#setting-up-vpn-access-to-the-university-network-from-an-ec2-instance" title="Permalink to this heading">¶</a></h1>
<section id="connecting-with-the-aws-ec2-instance">
<h2>Connecting with the AWS EC2 instance<a class="headerlink" href="#connecting-with-the-aws-ec2-instance" title="Permalink to this heading">¶</a></h2>
<p>To install the VPN client manually, it is necessary to connect with the EC2 instance using SSH. The changes made using SSH are only available till the instance is alive; upon stopping and starting a new instance, the manually made changes are lost.</p>
<p>To connect with the EC2 instance, it is necessary to install the AWS CLI and setup the SSH key pairs for authenticating with the AWS instance.</p>
</section>
<section id="installing-vpn-client">
<h2>Installing VPN Client<a class="headerlink" href="#installing-vpn-client" title="Permalink to this heading">¶</a></h2>
<p>The VPN client used to connect with Cisco gateways is not available by default in the EC2 instances and needs to be installed from the EPEL repository. The EPEL repository can be enabled using the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo amazon-linux-extras install epel -y
</pre></div>
</div>
<p>Next, the <code class="docutils literal notranslate"><span class="pre">openconnect</span></code> VPN client should be installed on the instance:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo yum install openconnect vpnc-script
</pre></div>
</div>
</section>
<section id="setting-up-vpn-slicing">
<h2>Setting up VPN Slicing<a class="headerlink" href="#setting-up-vpn-slicing" title="Permalink to this heading">¶</a></h2>
<p>The VPN client, <code class="docutils literal notranslate"><span class="pre">openconnect</span></code> can now be used to connect to the University Cisco gateway using a valid set of username and password. However, doing so would cause the EC2 instance to become a part of the University network and hence would loose its connectivity to the rest of the AWS cloud infrastructure. The EC2 instance would be lost as it cannot be reached via the AWS provided IP address. To avoid this scenario, it is necessary to configure the VPN client to only add a certain subnet of the University to its network configuration.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">vpn-slice</span></code> tool allows easy configuration of the <code class="docutils literal notranslate"><span class="pre">openconnect</span></code> VPN client for splitting the network routes.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo pip3 install https://github.com/dlenski/vpn-slice/archive/master.zip
</pre></div>
</div>
<p>This would install the <code class="docutils literal notranslate"><span class="pre">vpn-slice</span></code> package in the python site-packages and the <code class="docutils literal notranslate"><span class="pre">vpn-slice</span></code> executable in <code class="docutils literal notranslate"><span class="pre">/usr/local/bin</span></code>. To test it the first time, the following command can be executed:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo /usr/local/bin/vpn-slice --self-test
</pre></div>
</div>
</section>
<section id="connecting-to-the-university-network">
<h2>Connecting to the University Network<a class="headerlink" href="#connecting-to-the-university-network" title="Permalink to this heading">¶</a></h2>
<p>Now that <code class="docutils literal notranslate"><span class="pre">vpn-slice</span></code> is installed, it can be used to connect with just a specific subnet or host within the University network. The rest of the University network is not directly accessible from the EC2 instance and the EC2 instance does not loose its default gateway or any other routes.</p>
<p>The following command initiates the VPN connection. An appropriate unikey should be used to connect to the network (replace igho9814 with your unikey). The IP address mentioned at the end of the command is that of Trandy, a server within the University network: this can be replaced with any other relevant IP address (or subnet).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo openconnect vpn.sydney.edu.au -u igho9814 -s <span class="s1">&#39;/usr/local/bin/vpn-slice 10.65.67.87/31&#39;</span>
</pre></div>
</div>
<p>Invoking the above command would ask the unikey password after which, it should get successfully connected to the University network. The following output from the command shows that the EC2 instance connected with University network using the IP address <code class="docutils literal notranslate"><span class="pre">10.48.26.102</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POST</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">vpn</span><span class="o">.</span><span class="n">sydney</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">au</span><span class="o">/</span>
<span class="n">Connected</span> <span class="n">to</span> <span class="mf">129.78.42.50</span><span class="p">:</span><span class="mi">443</span>
<span class="n">SSL</span> <span class="n">negotiation</span> <span class="k">with</span> <span class="n">vpn</span><span class="o">.</span><span class="n">sydney</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">au</span>
<span class="n">Connected</span> <span class="n">to</span> <span class="n">HTTPS</span> <span class="n">on</span> <span class="n">vpn</span><span class="o">.</span><span class="n">sydney</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">au</span> <span class="k">with</span> <span class="n">ciphersuite</span> <span class="p">(</span><span class="n">TLS1</span><span class="mf">.2</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">SECP256R1</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">AES</span><span class="o">-</span><span class="mi">256</span><span class="o">-</span><span class="n">GCM</span><span class="p">)</span>
<span class="n">XML</span> <span class="n">POST</span> <span class="n">enabled</span>
<span class="n">Please</span> <span class="n">enter</span> <span class="n">your</span> <span class="n">username</span> <span class="ow">and</span> <span class="n">password</span><span class="o">.</span>
<span class="n">Password</span><span class="p">:</span> <span class="o">********</span>
<span class="n">POST</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">vpn</span><span class="o">.</span><span class="n">sydney</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">au</span><span class="o">/</span>
<span class="n">Got</span> <span class="n">CONNECT</span> <span class="n">response</span><span class="p">:</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">CSTP</span> <span class="n">connected</span><span class="o">.</span> <span class="n">DPD</span> <span class="mi">30</span><span class="p">,</span> <span class="n">Keepalive</span> <span class="mi">20</span>
<span class="n">Connected</span> <span class="k">as</span> <span class="mf">10.48.26.102</span><span class="p">,</span> <span class="n">using</span> <span class="n">SSL</span><span class="p">,</span> <span class="k">with</span> <span class="n">DTLS</span> <span class="ow">in</span> <span class="n">progress</span>
<span class="n">Established</span> <span class="n">DTLS</span> <span class="n">connection</span> <span class="p">(</span><span class="n">using</span> <span class="n">GnuTLS</span><span class="p">)</span><span class="o">.</span> <span class="n">Ciphersuite</span> <span class="p">(</span><span class="n">DTLS0</span><span class="mf">.9</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">DHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="mi">4294967237</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">AES</span><span class="o">-</span><span class="mi">256</span><span class="o">-</span><span class="n">CBC</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">SHA1</span><span class="p">)</span><span class="o">.</span>
</pre></div>
</div>
<p>The command would run in the foreground by default, so it can be started as a background process or from within a script.</p>
<p>The following output from <code class="docutils literal notranslate"><span class="pre">ip</span> <span class="pre">addr</span></code> shows that the EC2 instance acquired a new network interface named <code class="docutils literal notranslate"><span class="pre">tun0</span></code>, which uses the VPN connection.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ip addr
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000

...

8: tun0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1300 qdisc pfifo_fast state UNKNOWN group default qlen 500
    link/none
    inet 10.48.26.102/32 scope global tun0
       valid_lft forever preferred_lft forever
    inet6 fe80::7ed5:524b:70d8:1727/64 scope link stable-privacy
       valid_lft forever preferred_lft forever
</pre></div>
</div>
</section>
<section id="configuring-access-to-the-database">
<h2>Configuring Access to the Database<a class="headerlink" href="#configuring-access-to-the-database" title="Permalink to this heading">¶</a></h2>
<p>To setup access to the Realtime Imaging database, ensure that the web application configurations list the IP address of <code class="docutils literal notranslate"><span class="pre">Trandy</span></code> as the host for the data base. Apart from this, create a folder with the path <code class="docutils literal notranslate"><span class="pre">/mnt/uploads</span></code> and mount the CIFS filesystem exported from <code class="docutils literal notranslate"><span class="pre">Trandy</span></code> with the same name to this path. If the <code class="docutils literal notranslate"><span class="pre">cifs-utils</span></code> package is not installed already then it would need to installed before mounting the filesystem.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo mount -tcifs //10.65.67.87/uploads /mnt/uploads -ousername<span class="o">=</span>igho9814,uid<span class="o">=</span><span class="k">$(</span>id -u<span class="k">)</span>,gid<span class="o">=</span><span class="k">$(</span>id -g<span class="k">)</span>
</pre></div>
</div>
</section>
</section>
<section id="references">
<h1>References<a class="headerlink" href="#references" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p>Enabling <code class="docutils literal notranslate"><span class="pre">epel</span></code> repository in Amazon Linux 2 for installing additional packages: https://aws.amazon.com/premiumsupport/knowledge-center/ec2-enable-epel/</p></li>
<li><p>VPN configuration script reference: https://www.infradead.org/openconnect/vpnc-script.html</p></li>
<li><p>Current version of the VPN configuration script: https://gitlab.com/openconnect/vpnc-scripts/raw/master/vpnc-script</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">openconnect</span></code> manual: https://www.infradead.org/openconnect/manual.html</p></li>
<li><p>Wikipedia article on VPN split tunnelling: https://en.wikipedia.org/wiki/Split_tunneling</p></li>
<li><p>VPN Slice (split tunnelling) script: https://github.com/dlenski/vpn-slice</p></li>
</ul>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Packaging Demo</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Local_Deployment_Guide.html">LEARN DB Deployment Guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Setting up VPN access to the University Network from an EC2 instance</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#connecting-with-the-aws-ec2-instance">Connecting with the AWS EC2 instance</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installing-vpn-client">Installing VPN Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setting-up-vpn-slicing">Setting up VPN Slicing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#connecting-to-the-university-network">Connecting to the University Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuring-access-to-the-database">Configuring Access to the Database</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#references">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="HOW_TO_Add_new_patient_information.html">HOW TO Add New Trial/Test Centre/Patient Information</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="Local_Deployment_Guide.html" title="previous chapter">LEARN DB Deployment Guide</a></li>
      <li>Next: <a href="HOW_TO_Add_new_patient_information.html" title="next chapter">HOW TO Add New Trial/Test Centre/Patient Information</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Brendan Whelan.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/HOWTO_VPN_from_AWS_EC2_instance_to_the_University.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>